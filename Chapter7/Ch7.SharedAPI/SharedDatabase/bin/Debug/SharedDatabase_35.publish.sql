/*
Deployment script for Ch7SharedDatabase

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Ch7SharedDatabase"
:setvar DefaultFilePrefix "Ch7SharedDatabase"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The column [dbo].[Song].[ArtworkThumbURL] is being dropped, data loss could occur.

The type for column Controller in table [dbo].[Song] is currently  VARCHAR (255) NULL but is being changed to  VARCHAR (50) NULL. Data loss could occur.

The type for column GenreId in table [dbo].[Song] is currently  VARCHAR (50) NULL but is being changed to  INT NULL. Data loss could occur.
*/

IF EXISTS (select top 1 1 from [dbo].[Song])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'The following operation was generated from a refactoring log file e5001875-661a-4363-80f7-d4a28970f1b9';

PRINT N'Rename [dbo].[Song].[ArtistName] to Action';


GO
EXECUTE sp_rename @objname = N'[dbo].[Song].[ArtistName]', @newname = N'Action', @objtype = N'COLUMN';


GO
PRINT N'The following operation was generated from a refactoring log file 3c7e55c3-f2e8-4662-bb8a-10a6d16dc91c';

PRINT N'Rename [dbo].[Song].[ArtistProfileUrl] to Controller';


GO
EXECUTE sp_rename @objname = N'[dbo].[Song].[ArtistProfileUrl]', @newname = N'Controller', @objtype = N'COLUMN';


GO
PRINT N'The following operation was generated from a refactoring log file 82e0cd83-865c-40ba-8dc8-bf6a71c76e99';

PRINT N'Rename [dbo].[Song].[Genre] to GenreId';


GO
EXECUTE sp_rename @objname = N'[dbo].[Song].[Genre]', @newname = N'GenreId', @objtype = N'COLUMN';


GO
PRINT N'Dropping FK_PlaylistItem_Song...';


GO
ALTER TABLE [dbo].[PlaylistItem] DROP CONSTRAINT [FK_PlaylistItem_Song];


GO
PRINT N'Dropping FK_Song_Media...';


GO
ALTER TABLE [dbo].[Song] DROP CONSTRAINT [FK_Song_Media];


GO
PRINT N'Starting rebuilding table [dbo].[Song]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Song] (
    [SongId]          INT            IDENTITY (1, 1) NOT NULL,
    [MediaId]         INT            NOT NULL,
    [SongTitle]       VARCHAR (50)   NOT NULL,
    [ReleaseYear]     INT            NULL,
    [ArtworkURL]      VARCHAR (255)  NULL,
    [Lyrics]          VARCHAR (1024) NULL,
    [SongDescription] VARCHAR (1024) NULL,
    [ActionParameter] VARCHAR (50)   NULL,
    [Action]          VARCHAR (50)   NULL,
    [Controller]      VARCHAR (50)   NULL,
    [GenreId]         INT            DEFAULT 21 NULL,
    [CreateDate]      DATETIME       DEFAULT getDate() NOT NULL,
    [ShowInLibrary]   BIT            DEFAULT 1 NOT NULL,
    PRIMARY KEY CLUSTERED ([SongId] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Song])
    BEGIN
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Song] ON;
        INSERT INTO [dbo].[tmp_ms_xx_Song] ([SongId], [MediaId], [SongTitle], [ReleaseYear], [ArtworkURL], [Lyrics], [SongDescription], [Action], [Controller], [GenreId])
        SELECT   [SongId],
                 [MediaId],
                 [SongTitle],
                 [ReleaseYear],
                 [ArtworkURL],
                 [Lyrics],
                 [SongDescription],
                 [Action],
                 [Controller],
                 [GenreId]
        FROM     [dbo].[Song]
        ORDER BY [SongId] ASC;
        SET IDENTITY_INSERT [dbo].[tmp_ms_xx_Song] OFF;
    END

DROP TABLE [dbo].[Song];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Song]', N'Song';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating FK_PlaylistItem_Song...';


GO
ALTER TABLE [dbo].[PlaylistItem] WITH NOCHECK
    ADD CONSTRAINT [FK_PlaylistItem_Song] FOREIGN KEY ([SongId]) REFERENCES [dbo].[Song] ([SongId]);


GO
PRINT N'Creating FK_Song_Media...';


GO
ALTER TABLE [dbo].[Song] WITH NOCHECK
    ADD CONSTRAINT [FK_Song_Media] FOREIGN KEY ([MediaId]) REFERENCES [dbo].[Media] ([MediaId]);


GO
PRINT N'Refreshing [dbo].[u_DeleteArtist]...';


GO
EXECUTE sp_refreshsqlmodule N'dbo.u_DeleteArtist';


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'e5001875-661a-4363-80f7-d4a28970f1b9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('e5001875-661a-4363-80f7-d4a28970f1b9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '3c7e55c3-f2e8-4662-bb8a-10a6d16dc91c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('3c7e55c3-f2e8-4662-bb8a-10a6d16dc91c')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '82e0cd83-865c-40ba-8dc8-bf6a71c76e99')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('82e0cd83-865c-40ba-8dc8-bf6a71c76e99')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[PlaylistItem] WITH CHECK CHECK CONSTRAINT [FK_PlaylistItem_Song];

ALTER TABLE [dbo].[Song] WITH CHECK CHECK CONSTRAINT [FK_Song_Media];


GO
PRINT N'Update complete.'
GO
