/*
Deployment script for Ch7SharedDatabase

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Ch7SharedDatabase"
:setvar DefaultFilePrefix "Ch7SharedDatabase"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL11.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key fee81d5e-a3e9-4142-b316-6c140c01949a is skipped, element [dbo].[CollaborationSpaceGenre].[Id] (SqlSimpleColumn) will not be renamed to CollaborationSpaceGenreId';


GO
PRINT N'Rename refactoring operation with key 88152d09-e864-4d5a-a12a-1564d8fd26ba is skipped, element [dbo].[CollaborationSpaceInvite].[SenderId] (SqlSimpleColumn) will not be renamed to ArtistId';


GO
PRINT N'Rename refactoring operation with key 4741fea1-74a7-4723-b3ea-11271d358849 is skipped, element [dbo].[CollaborationSpaceInvite].[DateSent] (SqlSimpleColumn) will not be renamed to CreateDate';


GO
PRINT N'Rename refactoring operation with key 7c565b39-3712-4c23-a02d-2e181c016eb5 is skipped, element [dbo].[CollaborationSpaceInvite].[LinkHash] (SqlSimpleColumn) will not be renamed to LinkIdentifier';


GO
PRINT N'Rename refactoring operation with key c303d19c-fa9d-46ab-8b30-a2fa3124410e is skipped, element [dbo].[BandAudition].[PublishedMediaId] (SqlSimpleColumn) will not be renamed to SongId';


GO
PRINT N'Creating [dbo].[ArtistBlock]...';


GO
CREATE TABLE [dbo].[ArtistBlock] (
    [ArtistBlockId]   INT      NOT NULL,
    [ArtistId]        INT      NOT NULL,
    [BlockedArtistId] INT      NOT NULL,
    [CreateDate]      DATETIME NOT NULL,
    [ReportAsSpammer] BIT      NOT NULL,
    PRIMARY KEY CLUSTERED ([ArtistBlockId] ASC)
);


GO
PRINT N'Creating [dbo].[ArtistFavorites]...';


GO
CREATE TABLE [dbo].[ArtistFavorites] (
    [ArtistFavoriteId] INT          IDENTITY (1, 1) NOT NULL,
    [ArtistId]         INT          NOT NULL,
    [Title]            VARCHAR (50) NOT NULL,
    [ItemId]           INT          NULL,
    [Category]         INT          NOT NULL,
    [CreateDate]       DATETIME     NOT NULL,
    PRIMARY KEY CLUSTERED ([ArtistFavoriteId] ASC)
);


GO
PRINT N'Creating [dbo].[BandAudition]...';


GO
CREATE TABLE [dbo].[BandAudition] (
    [BandAuditionId]        INT          IDENTITY (1, 1) NOT NULL,
    [ProjectOpenPositionId] INT          NOT NULL,
    [ArtistId]              INT          NOT NULL,
    [SongId]                INT          NOT NULL,
    [VotesRequired]         INT          NOT NULL,
    [VotesRecieved]         INT          NOT NULL,
    [Status]                VARCHAR (10) NOT NULL,
    PRIMARY KEY CLUSTERED ([BandAuditionId] ASC)
);


GO
PRINT N'Creating [dbo].[BandAuditionComment]...';


GO
CREATE TABLE [dbo].[BandAuditionComment] (
    [BandAuditionCommentId] INT            IDENTITY (1, 1) NOT NULL,
    [BandAuditionId]        INT            NOT NULL,
    [ArtistId]              INT            NOT NULL,
    [Comment]               VARCHAR (1000) NOT NULL,
    [Rating]                INT            NOT NULL,
    [Vote]                  BIT            NOT NULL,
    PRIMARY KEY CLUSTERED ([BandAuditionCommentId] ASC)
);


GO
PRINT N'Creating [dbo].[BandGenre]...';


GO
CREATE TABLE [dbo].[BandGenre] (
    [BandGenreId]   INT NOT NULL,
    [BandId]        INT NOT NULL,
    [GenreLookUpId] INT NOT NULL,
    PRIMARY KEY CLUSTERED ([BandGenreId] ASC)
);


GO
PRINT N'Creating [dbo].[CollaborationSpaceAlerts]...';


GO
CREATE TABLE [dbo].[CollaborationSpaceAlerts] (
    [CollaborationSpaceAlertId] INT      NOT NULL,
    [CollaborationSpaceId]      INT      NOT NULL,
    [ArtistId]                  INT      NOT NULL,
    [CreateDate]                DATETIME NOT NULL,
    PRIMARY KEY CLUSTERED ([CollaborationSpaceAlertId] ASC)
);


GO
PRINT N'Creating [dbo].[CollaborationSpaceGenre]...';


GO
CREATE TABLE [dbo].[CollaborationSpaceGenre] (
    [CollaborationSpaceGenreId] INT NOT NULL,
    [CollaborationSpaceId]      INT NOT NULL,
    [GenreLookUpId]             INT NOT NULL,
    PRIMARY KEY CLUSTERED ([CollaborationSpaceGenreId] ASC)
);


GO
PRINT N'Creating [dbo].[CollaborationSpaceInvite]...';


GO
CREATE TABLE [dbo].[CollaborationSpaceInvite] (
    [CollaborationSpaceInviteId] INT              NOT NULL,
    [CollaborationSpaceId]       INT              NOT NULL,
    [EmailAddress]               VARCHAR (150)    NOT NULL,
    [ArtistId]                   INT              NOT NULL,
    [BandId]                     INT              NULL,
    [LinkIdentifier]             UNIQUEIDENTIFIER NOT NULL,
    [CreateDate]                 DATETIME         NOT NULL,
    PRIMARY KEY CLUSTERED ([CollaborationSpaceInviteId] ASC)
);


GO
PRINT N'Creating [dbo].[CollaborationSpaceMedia]...';


GO
CREATE TABLE [dbo].[CollaborationSpaceMedia] (
    [CollaborationSpaceMediaId] INT      NOT NULL,
    [CollaborationSpaceId]      INT      NOT NULL,
    [MediaId]                   INT      NOT NULL,
    [ModifiedDate]              DATETIME NOT NULL,
    [Archive]                   BIT      NOT NULL,
    PRIMARY KEY CLUSTERED ([CollaborationSpaceMediaId] ASC)
);


GO
PRINT N'Creating [dbo].[EmailOptOut]...';


GO
CREATE TABLE [dbo].[EmailOptOut] (
    [EmailAddress] VARCHAR (150) NOT NULL,
    [DateOfOptOut] DATETIME      NOT NULL,
    PRIMARY KEY CLUSTERED ([EmailAddress] ASC)
);


GO
PRINT N'Creating [dbo].[EmailVerification]...';


GO
CREATE TABLE [dbo].[EmailVerification] (
    [EmailVerificationId]  INT           IDENTITY (1, 1) NOT NULL,
    [ArtistId]             INT           NOT NULL,
    [emailaddress]         VARCHAR (150) NOT NULL,
    [VerificationCode]     VARCHAR (50)  NOT NULL,
    [NotificationSendDate] DATETIME      NOT NULL,
    [VerificationDate]     DATETIME      NULL,
    PRIMARY KEY CLUSTERED ([EmailVerificationId] ASC)
);


GO
PRINT N'Creating [dbo].[OpenPosition]...';


GO
CREATE TABLE [dbo].[OpenPosition] (
    [OpenPositionId]       INT            IDENTITY (1, 1) NOT NULL,
    [CollaborationSpaceId] INT            NULL,
    [Talent]               VARCHAR (50)   NOT NULL,
    [SkillLevel]           INT            NOT NULL,
    [Details]              VARCHAR (1000) NULL,
    [DatePosted]           DATETIME       NOT NULL,
    [DateModified]         DATETIME       NOT NULL,
    [Status]               INT            NOT NULL,
    [BandId]               INT            NULL,
    [LocalOnly]            BIT            NOT NULL,
    [LocalCity]            VARCHAR (50)   NULL,
    [LocalCountry]         VARCHAR (50)   NULL,
    [LocalProvence]        VARCHAR (50)   NULL,
    [AuditionsSubmitted]   INT            NOT NULL,
    [ApprovalMode]         INT            NOT NULL,
    PRIMARY KEY CLUSTERED ([OpenPositionId] ASC)
);


GO
PRINT N'Creating Default Constraint on [dbo].[ArtistBlock]....';


GO
ALTER TABLE [dbo].[ArtistBlock]
    ADD DEFAULT getdate() FOR [CreateDate];


GO
PRINT N'Creating Default Constraint on [dbo].[ArtistBlock]....';


GO
ALTER TABLE [dbo].[ArtistBlock]
    ADD DEFAULT 0 FOR [ReportAsSpammer];


GO
PRINT N'Creating Default Constraint on [dbo].[ArtistFavorites]....';


GO
ALTER TABLE [dbo].[ArtistFavorites]
    ADD DEFAULT getdate() FOR [CreateDate];


GO
PRINT N'Creating Default Constraint on [dbo].[BandAuditionComment]....';


GO
ALTER TABLE [dbo].[BandAuditionComment]
    ADD DEFAULT 0 FOR [Rating];


GO
PRINT N'Creating Default Constraint on [dbo].[BandAuditionComment]....';


GO
ALTER TABLE [dbo].[BandAuditionComment]
    ADD DEFAULT 0 FOR [Vote];


GO
PRINT N'Creating Default Constraint on [dbo].[CollaborationSpaceAlerts]....';


GO
ALTER TABLE [dbo].[CollaborationSpaceAlerts]
    ADD DEFAULT getdate() FOR [CreateDate];


GO
PRINT N'Creating Default Constraint on [dbo].[CollaborationSpaceMedia]....';


GO
ALTER TABLE [dbo].[CollaborationSpaceMedia]
    ADD DEFAULT getdate() FOR [ModifiedDate];


GO
PRINT N'Creating Default Constraint on [dbo].[CollaborationSpaceMedia]....';


GO
ALTER TABLE [dbo].[CollaborationSpaceMedia]
    ADD DEFAULT 0 FOR [Archive];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT 0 FOR [SkillLevel];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT getdate() FOR [DatePosted];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT getdate() FOR [DateModified];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT 0 FOR [Status];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT 0 FOR [LocalOnly];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT 0 FOR [AuditionsSubmitted];


GO
PRINT N'Creating Default Constraint on [dbo].[OpenPosition]....';


GO
ALTER TABLE [dbo].[OpenPosition]
    ADD DEFAULT 0 FOR [ApprovalMode];


GO
PRINT N'Creating FK_ArtistBlock_Artist...';


GO
ALTER TABLE [dbo].[ArtistBlock] WITH NOCHECK
    ADD CONSTRAINT [FK_ArtistBlock_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_ArtistFavorites_Artist...';


GO
ALTER TABLE [dbo].[ArtistFavorites] WITH NOCHECK
    ADD CONSTRAINT [FK_ArtistFavorites_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_BandAudition_Artist...';


GO
ALTER TABLE [dbo].[BandAudition] WITH NOCHECK
    ADD CONSTRAINT [FK_BandAudition_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_BandAudition_Song...';


GO
ALTER TABLE [dbo].[BandAudition] WITH NOCHECK
    ADD CONSTRAINT [FK_BandAudition_Song] FOREIGN KEY ([SongId]) REFERENCES [dbo].[Song] ([SongId]);


GO
PRINT N'Creating FK_BandAuditionComment_Artist...';


GO
ALTER TABLE [dbo].[BandAuditionComment] WITH NOCHECK
    ADD CONSTRAINT [FK_BandAuditionComment_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_BandAuditionComment_BandAudition...';


GO
ALTER TABLE [dbo].[BandAuditionComment] WITH NOCHECK
    ADD CONSTRAINT [FK_BandAuditionComment_BandAudition] FOREIGN KEY ([BandAuditionId]) REFERENCES [dbo].[BandAudition] ([BandAuditionId]);


GO
PRINT N'Creating FK_BandGenre_Band...';


GO
ALTER TABLE [dbo].[BandGenre] WITH NOCHECK
    ADD CONSTRAINT [FK_BandGenre_Band] FOREIGN KEY ([BandId]) REFERENCES [dbo].[Band] ([BandId]);


GO
PRINT N'Creating FK_BandGenre_GenreLookUp...';


GO
ALTER TABLE [dbo].[BandGenre] WITH NOCHECK
    ADD CONSTRAINT [FK_BandGenre_GenreLookUp] FOREIGN KEY ([GenreLookUpId]) REFERENCES [dbo].[GenreLookUp] ([GenreLookUpId]);


GO
PRINT N'Creating FK_CollaborationSpaceAlerts_CollaborationSpace...';


GO
ALTER TABLE [dbo].[CollaborationSpaceAlerts] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceAlerts_CollaborationSpace] FOREIGN KEY ([CollaborationSpaceId]) REFERENCES [dbo].[CollaborationSpace] ([CollaborationSpaceId]);


GO
PRINT N'Creating FK_CollaborationSpaceAlerts_Artist...';


GO
ALTER TABLE [dbo].[CollaborationSpaceAlerts] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceAlerts_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_CollaborationSpaceGenre_CollaborationSpace...';


GO
ALTER TABLE [dbo].[CollaborationSpaceGenre] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceGenre_CollaborationSpace] FOREIGN KEY ([CollaborationSpaceId]) REFERENCES [dbo].[CollaborationSpace] ([CollaborationSpaceId]);


GO
PRINT N'Creating FK_CollaborationSpaceGenre_GenreLookUp...';


GO
ALTER TABLE [dbo].[CollaborationSpaceGenre] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceGenre_GenreLookUp] FOREIGN KEY ([GenreLookUpId]) REFERENCES [dbo].[GenreLookUp] ([GenreLookUpId]);


GO
PRINT N'Creating FK_CollaborationSpaceInvite_CollaborationSpace...';


GO
ALTER TABLE [dbo].[CollaborationSpaceInvite] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceInvite_CollaborationSpace] FOREIGN KEY ([CollaborationSpaceId]) REFERENCES [dbo].[CollaborationSpace] ([CollaborationSpaceId]);


GO
PRINT N'Creating FK_CollaborationSpaceInvite_Artist...';


GO
ALTER TABLE [dbo].[CollaborationSpaceInvite] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceInvite_Artist] FOREIGN KEY ([ArtistId]) REFERENCES [dbo].[Artist] ([ArtistId]);


GO
PRINT N'Creating FK_CollaborationSpaceMedia_CollaborationSpace...';


GO
ALTER TABLE [dbo].[CollaborationSpaceMedia] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceMedia_CollaborationSpace] FOREIGN KEY ([CollaborationSpaceId]) REFERENCES [dbo].[CollaborationSpace] ([CollaborationSpaceId]);


GO
PRINT N'Creating FK_CollaborationSpaceMedia_ToTable_1...';


GO
ALTER TABLE [dbo].[CollaborationSpaceMedia] WITH NOCHECK
    ADD CONSTRAINT [FK_CollaborationSpaceMedia_ToTable_1] FOREIGN KEY ([MediaId]) REFERENCES [dbo].[Media] ([MediaId]);


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'fee81d5e-a3e9-4142-b316-6c140c01949a')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('fee81d5e-a3e9-4142-b316-6c140c01949a')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '88152d09-e864-4d5a-a12a-1564d8fd26ba')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('88152d09-e864-4d5a-a12a-1564d8fd26ba')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '4741fea1-74a7-4723-b3ea-11271d358849')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('4741fea1-74a7-4723-b3ea-11271d358849')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '7c565b39-3712-4c23-a02d-2e181c016eb5')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('7c565b39-3712-4c23-a02d-2e181c016eb5')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'c303d19c-fa9d-46ab-8b30-a2fa3124410e')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('c303d19c-fa9d-46ab-8b30-a2fa3124410e')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[ArtistBlock] WITH CHECK CHECK CONSTRAINT [FK_ArtistBlock_Artist];

ALTER TABLE [dbo].[ArtistFavorites] WITH CHECK CHECK CONSTRAINT [FK_ArtistFavorites_Artist];

ALTER TABLE [dbo].[BandAudition] WITH CHECK CHECK CONSTRAINT [FK_BandAudition_Artist];

ALTER TABLE [dbo].[BandAudition] WITH CHECK CHECK CONSTRAINT [FK_BandAudition_Song];

ALTER TABLE [dbo].[BandAuditionComment] WITH CHECK CHECK CONSTRAINT [FK_BandAuditionComment_Artist];

ALTER TABLE [dbo].[BandAuditionComment] WITH CHECK CHECK CONSTRAINT [FK_BandAuditionComment_BandAudition];

ALTER TABLE [dbo].[BandGenre] WITH CHECK CHECK CONSTRAINT [FK_BandGenre_Band];

ALTER TABLE [dbo].[BandGenre] WITH CHECK CHECK CONSTRAINT [FK_BandGenre_GenreLookUp];

ALTER TABLE [dbo].[CollaborationSpaceAlerts] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceAlerts_CollaborationSpace];

ALTER TABLE [dbo].[CollaborationSpaceAlerts] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceAlerts_Artist];

ALTER TABLE [dbo].[CollaborationSpaceGenre] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceGenre_CollaborationSpace];

ALTER TABLE [dbo].[CollaborationSpaceGenre] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceGenre_GenreLookUp];

ALTER TABLE [dbo].[CollaborationSpaceInvite] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceInvite_CollaborationSpace];

ALTER TABLE [dbo].[CollaborationSpaceInvite] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceInvite_Artist];

ALTER TABLE [dbo].[CollaborationSpaceMedia] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceMedia_CollaborationSpace];

ALTER TABLE [dbo].[CollaborationSpaceMedia] WITH CHECK CHECK CONSTRAINT [FK_CollaborationSpaceMedia_ToTable_1];


GO
PRINT N'Update complete.'
GO
